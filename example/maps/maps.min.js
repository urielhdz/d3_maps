function Map(e,t){if(typeof t==="undefined")t={};if(typeof e==="undefined")e="body";var n=this;n.width=t.hasOwnProperty("width")?t.width:800;n.height=t.hasOwnProperty("height")?t.height:600;n.scale=t.hasOwnProperty("scale")?t.scale:100;n.mouse_over=t.hasOwnProperty("mouse_over")?t.mouse_over:false;n.url=t.hasOwnProperty("url")?t.url:"maps/countries.geo.json";n.selector=e;n.projection=d3.geo.mercator().translate([n.width/2,n.height/2]).scale([n.scale]);n.path=d3.geo.path().projection(n.projection);n.svg=d3.select(e).append("svg").attr({width:n.width,height:n.height});n.highlightCountries=function(e,t,r){d3.csv("maps/relatives.csv",function(e){return{name:e.name,iso_name:e.iso_name,iso2:e.iso2,iso3:e.iso3,numcode:+e.numcode}},function(i,s){n.countries_data=s;n.applyHighlightCountries(e,t,r)})};n.applyHighlightCountries=function(e,t,r){if(typeof r==="undefined")r={};var i=r.hasOwnProperty("color")?r.color:"yellow";for(var s=0;s<e.length;s++){var o=e[s];if(o.length>3){var u=n.searchForCode(o);if(u){d3.select("#"+u).attr("fill",i)}}else{d3.select("#"+o).attr("fill",i)}}t()};n.heatCountries=function(e,t,r){if(typeof n.countries_data==="undefined"){d3.csv("maps/relatives.csv",function(e){return{name:e.name,iso_name:e.iso_name,iso2:e.iso2,iso3:e.iso3,numcode:+e.numcode}},function(e,i){n.countries_data=i;n.applyHeatCountries(countries_array,t,r)})}};n.applyHeatCountries=function(e,t,r){if(typeof r==="undefined")r={};var i=r.hasOwnProperty("color")?r.color:false;var s=Infinity;var o=-Infinity;for(country in e){var u=e[country];if(u>o){o=u}if(u<s){s=u}}if(s==Infinity||o==-Infinity){for(country in e){n.heatCountry(country,i)}}for(country in e){var u=e[country];var a=(u-s)/(o-s)*100;a+=20;var f=parseInt(a%1);var l=parseInt(a);if(i){var c=i.replace(",0)",","+a+")")}else{var c="rgb("+(300-l*2)+","+(255-l*2)+", "+(255-l*2)+")"}n.heatCountry(country,c)}if(typeof t!="undefined")t()};n.heatCountry=function(e,t){if(e.length>3){var r=n.searchForCode(e);if(r){d3.select("#"+r).attr("fill",t)}}else{d3.select("#"+e).attr("fill",t)}};n.searchForCode=function(e){var t=e.toLowerCase();var r=n.countries_data.filter(function(e){return e.name.toLowerCase()==t||e.iso_name.toLowerCase()==t});if(r.length>0){return r[0].iso3}return null};n.fill=function(e,t){if(typeof t==="undefined")t={};var r=t.hasOwnProperty("color")?t.color:"#333";d3.json(n.url,function(i){n.svg.selectAll("path").data(i.features).enter().append("path").attr("id",function(e){return e.id}).attr("d",n.path).attr("fill",r).attr("class","transitionable").on("mouseover",function(){if(n.mouse_over){d3.select("#"+this.id).attr("opacity","0.7")}}).on("mouseout",function(){d3.select("#"+this.id).attr("opacity","1")}).on("click",function(){console.log(":p");if(t.hasOwnProperty("click")){t.click(this)}});if(typeof e!="undefined")e()})};n.stroke=function(e,t){if(typeof t==="undefined")t={};var r=t.hasOwnProperty("color")?t.color:"#333";var i=t.hasOwnProperty("strokeWidth")?t.strokeWidth:"1";d3.json(n.url,function(s){n.svg.selectAll("path").data(s.features).enter().append("path").attr("id",function(e){return e.id}).attr("d",n.path).attr("stroke",r).attr("stroke-width",i).attr("fill","rgba(0,0,0,0)").attr("class","transitionable").on("mouseover",function(){if(n.mouse_over){d3.select("#"+this.id).attr("opacity","0.9")}}).on("mouseout",function(){d3.select("#"+this.id).attr("opacity","1")}).on("click",function(){if(t.hasOwnProperty("click")){t.click(this)}});if(typeof e!="undefined")e()})}}